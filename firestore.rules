rules_version = '2';

// Firestore security rules for AuditSim Pro
// Admins can manage all data. Trainees may only
// access cases they are authorized for and their own submissions. Roles are enforced via roles/{uid} documents.
service cloud.firestore {
  match /databases/{database}/documents {
    // Role helpers (supports both custom claims and Firestore mirror)
    function roleEquals(roleValue, expected) {
      return roleValue is string && roleValue.matches('(?i)^' + expected + '$');
    }

    function getRoleFromDoc() {
      return request.auth != null
        ? get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role
        : null;
    }

    function hasRole(expected) {
      return request.auth != null && (
        roleEquals(request.auth.token.role, expected) ||
        roleEquals(getRoleFromDoc(), expected)
      );
    }

    function isOwner() {
      return hasRole('owner');
    }

    function isAdmin() {
      return hasRole('admin') || isOwner();
    }

    function isPlatformAdmin() {
      return hasRole('admin');
    }

    function isTrainee() {
      return hasRole('trainee');
    }

    function isInstructor() {
      return hasRole('instructor');
    }

    // Checks if the trainee can view the case currently being read
    function traineeCaseAccessible() {
      return (
        !(resource.data.visibleToUserIds is list) ||
        resource.data.visibleToUserIds.size() == 0 ||
        request.auth.uid in resource.data.visibleToUserIds
      );
    }

    function belongsToOrg(resourceData) {
      return isAdmin() ||
        resourceData.publicVisible == true ||
        (
          request.auth.token.orgId != null &&
          resourceData.orgId == request.auth.token.orgId
        );
    }

    function isValidSupportingDocument(doc) {
      return doc is map &&
             (!('storagePath' in doc) || doc.storagePath == null || doc.storagePath is string) &&
             (!('downloadURL' in doc) || doc.downloadURL == null || doc.downloadURL is string) &&
             (!('fileName' in doc) || doc.fileName == null || doc.fileName is string) &&
             (!('contentType' in doc) || doc.contentType == null || doc.contentType is string);
    }

    function isValidAnswerKey(ak) {
      return ak is map &&
             (!('properlyIncluded' in ak) || ak.properlyIncluded == null || ak.properlyIncluded is number) &&
             (!('properlyExcluded' in ak) || ak.properlyExcluded == null || ak.properlyExcluded is number) &&
             (!('improperlyIncluded' in ak) || ak.improperlyIncluded == null || ak.improperlyIncluded is number) &&
             (!('improperlyExcluded' in ak) || ak.improperlyExcluded == null || ak.improperlyExcluded is number) &&
             (!('explanation' in ak) || ak.explanation == null || ak.explanation is string);
    }

    function isValidAuditItem(item) {
      return item is map &&
             item.keys().hasAll(['id', 'type']) &&
             item.id is string &&
             item.type in ['transaction', 'inventory_count', 'payroll_record'];
    }

    function isValidInvoiceMapping(m) {
      return m is map &&
             m.keys().hasAll(['paymentId']) &&
             m.paymentId is string &&
             (!('storagePath' in m) || m.storagePath == null || m.storagePath is string) &&
             (!('downloadURL' in m) || m.downloadURL == null || m.downloadURL is string) &&
             (!('fileName' in m) || m.fileName == null || m.fileName is string) &&
             (!('contentType' in m) || m.contentType == null || m.contentType is string);
    }

    function isValidClassificationDraftEntry(entry) {
      return entry is map &&
             (entry.keys().size() == 0 || ((entry[entry.keys()[0]] == null) || (entry[entry.keys()[0]] is string)));
    }

    function isValidProgressDraft(draft) {
      return draft is map &&
             (!('selectedPaymentIds' in draft) || (
               draft.selectedPaymentIds is list &&
               (draft.selectedPaymentIds.size() == 0 || draft.selectedPaymentIds[0] is string)
             )) &&
             (!('classificationDraft' in draft) || (
               draft.classificationDraft is map &&
               (
                 draft.classificationDraft.keys().size() == 0 ||
                 isValidClassificationDraftEntry(draft.classificationDraft[draft.classificationDraft.keys()[0]])
               )
             ));
    }

    function isValidProgressDocument(data) {
      return data.state in ['not_started', 'in_progress', 'submitted'] &&
             data.percentComplete >= 0 && data.percentComplete <= 100 &&
             (!('step' in data) || data.step in ['selection', 'support', 'testing', 'results']) &&
             (!('draft' in data) || isValidProgressDraft(data.draft));
    }

    function isValidCaseDocument() {
      return request.resource.data.keys().hasAll(['publicVisible', 'status', '_deleted']) &&
             request.resource.data.publicVisible is bool &&
             request.resource.data._deleted is bool &&
             request.resource.data.status in ['assigned', 'in_progress', 'submitted', 'archived', 'draft'] &&
             request.resource.data.updatedAt is timestamp &&
             request.resource.data.createdAt is timestamp &&
             (!('createdBy' in request.resource.data) || request.resource.data.createdBy == null || request.resource.data.createdBy is string) &&
             (!('caseLevel' in request.resource.data) || request.resource.data.caseLevel == null || request.resource.data.caseLevel in ['basic', 'intermediate', 'advanced']) &&
             (!('dueAt' in request.resource.data) || request.resource.data.dueAt == null || request.resource.data.dueAt is timestamp) &&
             (!('opensAt' in request.resource.data) || request.resource.data.opensAt == null || request.resource.data.opensAt is timestamp) &&
             (!('auditItems' in request.resource.data) || (
               request.resource.data.auditItems is list &&
               (
                 request.resource.data.auditItems.size() == 0 ||
                 isValidAuditItem(request.resource.data.auditItems[0])
               )
             )) &&
             (!('disbursements' in request.resource.data) || (
               request.resource.data.disbursements is list &&
               (
                 request.resource.data.disbursements.size() == 0 ||
                 isValidAuditItem(request.resource.data.disbursements[0])
               )
             )) &&
             (!('invoiceMappings' in request.resource.data) || (
               request.resource.data.invoiceMappings is list &&
             (
               request.resource.data.invoiceMappings.size() == 0 ||
               isValidInvoiceMapping(request.resource.data.invoiceMappings[0])
             )
           ));
    }

    function isValidTraineeCaseDocument() {
      return request.resource.data.keys().hasAll(['publicVisible', 'status', '_deleted']) &&
             request.resource.data.publicVisible is bool &&
             request.resource.data._deleted is bool &&
             request.resource.data.status in ['assigned', 'in_progress', 'submitted', 'archived', 'draft'] &&
             (!('createdBy' in request.resource.data) || request.resource.data.createdBy == null || request.resource.data.createdBy is string) &&
             (!('caseLevel' in request.resource.data) || request.resource.data.caseLevel == null || request.resource.data.caseLevel in ['basic', 'intermediate', 'advanced']) &&
             (!('dueAt' in request.resource.data) || request.resource.data.dueAt == null || request.resource.data.dueAt is timestamp) &&
             (!('opensAt' in request.resource.data) || request.resource.data.opensAt == null || request.resource.data.opensAt is timestamp) &&
             (!('auditItems' in request.resource.data) || (
               request.resource.data.auditItems is list &&
               (
                 request.resource.data.auditItems.size() == 0 ||
                 isValidAuditItem(request.resource.data.auditItems[0])
               )
             )) &&
             (!('disbursements' in request.resource.data) || (
               request.resource.data.disbursements is list &&
               (
                 request.resource.data.disbursements.size() == 0 ||
                 isValidAuditItem(request.resource.data.disbursements[0])
               )
             )) &&
             (!('invoiceMappings' in request.resource.data) || (
               request.resource.data.invoiceMappings is list &&
             (
               request.resource.data.invoiceMappings.size() == 0 ||
               isValidInvoiceMapping(request.resource.data.invoiceMappings[0])
             )
           ));
    }

    function traineeCaseCreateAllowed() {
      return request.auth != null &&
        request.resource.data.publicVisible == false &&
        request.resource.data._deleted == false &&
        (request.resource.data.status in ['assigned', 'in_progress', 'submitted', 'archived', 'draft']) &&
        request.resource.data.visibleToUserIds is list &&
        request.resource.data.visibleToUserIds.size() == 1 &&
        request.auth.uid in request.resource.data.visibleToUserIds;
    }

    function isValidCaseKeyEntry(entry) {
      return entry is map &&
             (!('answerKey' in entry) || entry.answerKey == null || isValidAnswerKey(entry.answerKey)) &&
             (!('answerKeyMode' in entry) || entry.answerKeyMode == null || entry.answerKeyMode is string) &&
             (!('answerKeySingleClassification' in entry) || entry.answerKeySingleClassification == null || entry.answerKeySingleClassification is string) &&
             (!('groundTruths' in entry) || entry.groundTruths == null || entry.groundTruths is map) &&
             (!('correctClassification' in entry) || entry.correctClassification == null || entry.correctClassification is string) &&
             (!('primaryAssertion' in entry) || entry.primaryAssertion == null || entry.primaryAssertion is string);
    }

    function isValidCaseKeyDocument(data) {
      return data is map &&
             (!('items' in data) || (
               data.items is map &&
               (
                 data.items.size() == 0 ||
                 isValidCaseKeyEntry(data.items[data.items.keys()[0]])
               )
             )) &&
             (!('updatedAt' in data) || data.updatedAt == request.time || data.updatedAt is timestamp);
    }

    function canAccessCaseKeys(appId, caseId) {
      return isAdmin() ||
        (
          isInstructor() &&
          request.auth.token.orgId != null &&
          exists(/databases/$(database)/documents/artifacts/$(appId)/public/data/cases/$(caseId)) &&
          get(/databases/$(database)/documents/artifacts/$(appId)/public/data/cases/$(caseId)).data.orgId ==
            request.auth.token.orgId
        ) ||
        (
          isTrainee() &&
          exists(/databases/$(database)/documents/artifacts/$(appId)/public/data/cases/$(caseId)) &&
          request.auth.uid in get(/databases/$(database)/documents/artifacts/$(appId)/public/data/cases/$(caseId)).data.visibleToUserIds
        );
    }

    function gradeFieldUnchanged(field) {
      return !(field in request.resource.data) ||
             (
               resource.data != null &&
               (field in resource.data) &&
               request.resource.data[field] == resource.data[field]
             );
    }

    // Role documents store whether a user is an admin, owner, or trainee
    match /roles/{userId} {
      // Allow users to read their own role document (for display/initial setup)
      allow read: if request.auth != null && request.auth.uid == userId;
      // Allow a user to create their own role document with any role.
      allow create: if request.auth != null && request.auth.uid == userId;
      // Role updates should primarily be handled by a trusted backend service (e.g., Cloud Function)
      allow update: if request.auth != null && isAdmin(); // Still allow admin client-side if needed, but custom claims are source of truth
    }

    // Case documents accessible to trainees if authorized
    match /artifacts/{appId}/public/data/cases/{caseId} {
      // For single document reads, the function is secure.
      allow get: if request.auth != null && (
        isAdmin() ||
        resource.data.publicVisible == true ||
        (
          resource.data.visibleToUserIds is list &&
          request.auth.uid in resource.data.visibleToUserIds
        ) ||
        (
          belongsToOrg(resource.data) &&
          (
            isInstructor() ||
            (isTrainee() && traineeCaseAccessible())
          )
        )
      );
      // For queries, allow any signed-in user; visibility is enforced by query filters (publicVisible/visibleToUserIds)
      // and downstream UI guards.
      allow list: if request.auth != null;
      allow create: if request.auth != null &&
        (
          isAdmin() ||
          (
            isInstructor() &&
            request.resource.data.orgId == request.auth.token.orgId &&
            isValidCaseDocument()
          ) ||
          (
            traineeCaseCreateAllowed() &&
            isValidTraineeCaseDocument()
          )
        );
      allow update: if request.auth != null &&
        (
          isAdmin() ||
          (
            isInstructor() &&
            resource.data.orgId == request.auth.token.orgId &&
            isValidCaseDocument()
          )
        );
      allow delete: if request.auth != null && isAdmin();
    }

    // Private answer keys stored under artifacts/{appId}/private/data/case_keys/{caseId}
    match /artifacts/{appId}/private/data/case_keys/{caseId} {
      allow read: if request.auth != null && canAccessCaseKeys(appId, caseId);
      allow create, update: if request.auth != null &&
                               canAccessCaseKeys(appId, caseId) &&
                               isValidCaseKeyDocument(request.resource.data);
      allow delete: if request.auth != null && isAdmin();
    }

    // Private case generation plans stored under artifacts/{appId}/private/data/case_generation_plans/{caseId}
    match /artifacts/{appId}/private/data/case_generation_plans/{caseId} {
      allow read: if request.auth != null && canAccessCaseKeys(appId, caseId);
      allow create, update: if request.auth != null &&
                               canAccessCaseKeys(appId, caseId) &&
                               request.resource.data.plan is map &&
                               request.resource.data.updatedAt == request.time;
      allow delete: if request.auth != null && isAdmin();
    }

    // Profile information is private to each user
    match /artifacts/{appId}/users/{userId} {
      allow read: if request.auth != null && isAdmin();
      allow write: if false;
    }

    match /artifacts/{appId}/users/{userId}/userProfileData/profile {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    function isSubmissionOwner(path) {
      return request.auth != null &&
             request.auth.uid is string &&
             path.matches('^artifacts/[^/]+/users/' + request.auth.uid + '$');
    }

    // Trainees submit their work under this path
    match /artifacts/{appId}/users/{userId}/caseSubmissions/{caseId} {
      allow read: if request.auth != null && (isAdmin() || request.auth.uid == userId);
      allow create, update: if request.auth != null &&
                               request.auth.uid == userId &&
                               isTrainee() &&
                               gradeFieldUnchanged('grade') &&
                               gradeFieldUnchanged('gradedAt');
      allow delete: if false;
    }

    match /{path=**}/caseSubmissions/{caseId} {
      allow read: if request.auth != null && isAdmin();
      allow create, update: if request.auth != null &&
                               isSubmissionOwner(path) &&
                               isTrainee() &&
                               gradeFieldUnchanged('grade') &&
                               gradeFieldUnchanged('gradedAt');
      allow delete: if false;
    }


    // Student progress is private to each user
    match /artifacts/{appId}/student_progress/{uid}/cases/{caseId} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
      // validation
      allow create, update: if isValidProgressDocument(request.resource.data) &&
                               request.resource.data.updatedAt == request.time;
    }

    // Recipe progress (gate completion) is private to each user
    match /artifacts/{appId}/student_progress/{uid}/recipes/{recipeId} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // Recipe documents provide module instructions/gates
    match /artifacts/{appId}/public/data/recipes/{recipeId} {
      allow read: if request.auth != null && (isAdmin() || isInstructor() || isTrainee());
      allow create, update, delete: if request.auth != null && isAdmin();
    }

    // Billing summary snapshot (server-writable only)
    match /artifacts/{appId}/billing/orgs/{orgId} {
      allow read: if request.auth != null && (
        (isOwner() && request.auth.token.orgId != null && request.auth.token.orgId == orgId) ||
        isPlatformAdmin()
      );
      allow create, update, delete: if false;
    }


    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
