rules_version = '2';

// Cloud Storage rules for AuditSim Pro
// Uses Firestore role documents to enforce RBAC
service firebase.storage {
  match /b/{bucket}/o {

    // Retrieves user role from Firestore
    function getUserRole() {
      return request.auth != null ?
        firestore.get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role : null;
    }

    function isAdmin() {
      return getUserRole() == 'admin';
    }

    // Verifies the trainee has access to the specified case
    function traineeHasAccessToCase(caseId) {
      return firestore.exists(/databases/$(database)/documents/artifacts/$(appId)/cases/$(caseId)/authorizedTrainees/$(request.auth.uid));
    }

    // PDF documents attached to a case
    match /artifacts/{appId}/case_documents/{caseId}/{fileName} {
      allow read: if getUserRole() != null &&
                   ( isAdmin() ||
                     (getUserRole() == 'trainee' && traineeHasAccessToCase(caseId))
                   );

      allow write: if getUserRole() != null && isAdmin() &&
                      request.resource.contentType.matches('application/pdf') &&
                      request.resource.size < 5 * 1024 * 1024;
    }
  }
}