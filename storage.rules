rules_version = '2';

// Cloud Storage rules for AuditSim Pro
// Uses Firestore role documents to enforce RBAC
service firebase.storage {
  match /b/{bucket}/o {

    // Check user role from custom claims or fallback role document
    function getRole() {
      let roleDoc = firestore.get(/databases/(default)/documents/roles/$(request.auth.uid));
      return roleDoc.exists() ? roleDoc.data.role : null;
    }
    function isAdmin() {
      return request.auth != null &&
             (request.auth.token.role == 'admin' || getRole() == 'admin');
    }
    function isTrainee() {
      return request.auth != null &&
             (request.auth.token.role == 'trainee' || getRole() == 'trainee');
    }

    // Verifies the trainee has access to the specified case by checking the Firestore case document
    // This requires a read from Firestore, which is allowed for 'get' operations in Storage rules.
    function traineeHasAccessToCase(appId, caseId) {
      let caseDoc = firestore.get(/databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId));
      return caseDoc.exists() && (
        !(caseDoc.data.visibleToUserIds is list) ||
        caseDoc.data.visibleToUserIds.size() == 0 ||
        caseDoc.data.visibleToUserIds.hasAny([request.auth.uid])
      );
    }

    // PDF documents attached to a case
    match /artifacts/{appId}/case_documents/{caseId}/{fileName} {
      allow read: if request.auth != null &&
                   (
                     isAdmin() || // Admins can read all case documents
                     (isTrainee() && traineeHasAccessToCase(appId, caseId)) // Trainees can read if authorized
                   );

      allow write: if request.auth != null && isAdmin() && // Only admins can write case documents
                      (
                        request.resource.contentType == 'application/pdf' ||
                        (
                          request.resource.contentType == 'application/octet-stream' &&
                          fileName.matches('(?i).*\\.pdf$')  // enforce .pdf extension when MIME is generic
                        )
                      ) &&
                      request.resource.size < 5 * 1024 * 1024; // 5 MB limit
    }
  }
}