rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ---------- Role helpers ----------
    // Custom claim on the ID token
    function hasCustomAdminClaim() {
      return request.auth != null && (
        request.auth.token.admin == true ||
        request.auth.token.role == 'admin'
      );
    }

    // Global roles/{uid} doc
    function hasGlobalAdminRole() {
      return request.auth != null &&
             firestore.exists(
               /databases/(default)/documents/roles/$(request.auth.uid)
             ) &&
             firestore.get(
               /databases/(default)/documents/roles/$(request.auth.uid)
             ).data.role == 'admin';
    }

    // Per-app profile: artifacts/{appId}/users/{uid}/userProfileData/profile
    function hasProfileAdminRole(appId) {
      return request.auth != null &&
             firestore.exists(
               /databases/(default)/documents/artifacts/$(appId)/users/$(request.auth.uid)/userProfileData/profile
             ) &&
             firestore.get(
               /databases/(default)/documents/artifacts/$(appId)/users/$(request.auth.uid)/userProfileData/profile
             ).data.role == 'admin';
    }

    function isAdmin(appId) {
      return hasCustomAdminClaim() || hasGlobalAdminRole() || hasProfileAdminRole(appId);
    }

    // ---------- Trainee visibility helper ----------
    // artifacts/{appId}/public/data/cases/{caseId} with visibleToUserIds (list)
    function traineeHasAccessToCase(appId, caseId) {
      return request.auth != null &&
             firestore.exists(
               /databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId)
             ) &&
             (
               // If field is missing or not a list -> treat as visible to signed-in users
               !(firestore.get(
                  /databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId)
                ).data.visibleToUserIds is list) ||
               // Empty list means public-to-signed-in users
               firestore.get(
                 /databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId)
               ).data.visibleToUserIds.size() == 0 ||
               // Explicit membership
               firestore.get(
                 /databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId)
               ).data.visibleToUserIds.hasAny([request.auth.uid])
             );
    }

    // ---------- Case document rules ----------
    // Accept any nested object names under a case
    match /artifacts/{appId}/case_documents/{caseId}/{file=**} {

      // Admin-only writes; PDF only (by MIME or .pdf extension); <= 25 MB
      allow create, update: if isAdmin(appId)
        && request.resource != null
        && (
             request.resource.contentType == 'application/pdf' ||
             (
               request.resource.contentType == 'application/octet-stream' &&
               request.resource.name.matches('(?i).*\\.pdf$') // tolerate generic MIME if name ends with .pdf
             )
           )
        && request.resource.size <= 25 * 1024 * 1024;

      // Reads: admins OR trainees who can see the case
      allow get, list: if isAdmin(appId) || traineeHasAccessToCase(appId, caseId);

      // Deletes: admins only
      allow delete: if isAdmin(appId);
    }
  }
}