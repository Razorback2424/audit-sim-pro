rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ---------- Role helpers ----------
    // Global roles/{uid} doc
    function isAdminRole(roleValue) {
      return roleValue is string && roleValue.matches('(?i)^admin$');
    }

    function isOwnerRole(roleValue) {
      return roleValue is string && roleValue.matches('(?i)^owner$');
    }

    function hasGlobalAdminRole() {
      return request.auth != null && (
        isAdminRole(request.auth.token.role) ||
        isOwnerRole(request.auth.token.role) ||
        (
          firestore.exists(/databases/(default)/documents/roles/$(request.auth.uid)) &&
          (
            isAdminRole(firestore.get(/databases/(default)/documents/roles/$(request.auth.uid)).data.role) ||
            isOwnerRole(firestore.get(/databases/(default)/documents/roles/$(request.auth.uid)).data.role)
          )
        )
      );
    }

    function isAdmin(appId) {
      return hasGlobalAdminRole();
    }

    function hasPaidAccess(appId) {
      return request.auth != null &&
        firestore.exists(/databases/(default)/documents/artifacts/$(appId)/users/$(request.auth.uid)/billing/status) &&
        (
          firestore.get(/databases/(default)/documents/artifacts/$(appId)/users/$(request.auth.uid)/billing/status).data.status == 'active'
        );
    }

    function caseDocExists(appId, caseId) {
      return firestore.exists(/databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId));
    }

    function isDemoCase(appId, caseId) {
      return caseDocExists(appId, caseId) &&
        firestore.get(/databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId)).data.accessLevel == 'demo';
    }

    function isPublicDemoCase(appId, caseId) {
      return isDemoCase(appId, caseId) &&
        firestore.get(/databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId)).data.publicVisible == true;
    }

    // ---------- Trainee visibility helper ----------
    // artifacts/{appId}/public/data/cases/{caseId} with visibleToUserIds (list)
    function caseIsVisibleToUser(appId, caseId) {
      return (
        firestore.get(/databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId)).data.publicVisible == true ||
        (
          (firestore.get(/databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId)).data.visibleToUserIds is list) &&
          firestore.get(/databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId)).data.visibleToUserIds.hasAny([request.auth.uid])
        )
      );
    }

    function caseNotDeleted(appId, caseId) {
      return firestore.get(/databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId)).data._deleted == false;
    }

    function unpaidDemoCaseAccessible(appId, caseId) {
      return isDemoCase(appId, caseId) &&
        firestore.get(/databases/(default)/documents/artifacts/$(appId)/public/data/cases/$(caseId)).data.publicVisible == true &&
        caseNotDeleted(appId, caseId);
    }

    function paidCaseAccessible(appId, caseId) {
      return caseNotDeleted(appId, caseId) && caseIsVisibleToUser(appId, caseId);
    }

    function traineeHasAccessToCase(appId, caseId) {
      return (
        (
          request.auth != null &&
          caseDocExists(appId, caseId) &&
          (
            (hasPaidAccess(appId) && paidCaseAccessible(appId, caseId)) ||
            (!hasPaidAccess(appId) && unpaidDemoCaseAccessible(appId, caseId))
          )
        ) ||
        (
          request.auth == null &&
          isPublicDemoCase(appId, caseId)
        )
      );
    }

    function hasAllowedExtension() {
      return request.resource != null &&
             request.resource.name.matches('(?i).*(\\.(pdf|csv|xls|xlsx|xlsm))$');
    }

    function hasAllowedContentType() {
      return request.resource != null && (
        request.resource.contentType == 'application/pdf' ||
        request.resource.contentType == 'application/x-pdf' ||
        request.resource.contentType == 'text/csv' ||
        request.resource.contentType == 'application/csv' ||
        request.resource.contentType == 'application/vnd.ms-excel' ||
        request.resource.contentType == 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
        request.resource.contentType == 'application/vnd.ms-excel.sheet.macroenabled.12'
      );
    }

    function isAllowedArtifactUpload() {
      return request.resource != null
        && request.resource.size <= 25 * 1024 * 1024
        && (hasAllowedContentType() || hasAllowedExtension());
    }

    // ---------- Case document rules ----------
    // Accept any nested object names under a case
    match /artifacts/{appId}/case_documents/{caseId}/{file=**} {

      // Admin-only writes; limited to supported formats; <= 25 MB
      allow create, update: if isAdmin(appId) && isAllowedArtifactUpload();

      // Reads: admins OR trainees who can see the case
      allow get, list: if isAdmin(appId) || traineeHasAccessToCase(appId, caseId);

      // Deletes: admins only
      allow delete: if isAdmin(appId);
    }

    // ---------- Reference document rules ----------
    match /artifacts/{appId}/case_reference/{caseId}/{file=**} {
      allow create, update: if isAdmin(appId) && isAllowedArtifactUpload();
      allow get, list: if isAdmin(appId) || traineeHasAccessToCase(appId, caseId);
      allow delete: if isAdmin(appId);
    }

    // ---------- Debug reference documents (admin-only) ----------
    match /artifacts/{appId}/debug/reference/{file=**} {
      allow create, update: if isAdmin(appId) && isAllowedArtifactUpload();
      allow get, list, delete: if isAdmin(appId);
    }

    // ---------- Highlighted evidence (admin-prepared answer key snippets) ----------
    match /artifacts/{appId}/case_highlight/{caseId}/{file=**} {
      allow create, update: if isAdmin(appId) && isAllowedArtifactUpload();
      allow get, list: if isAdmin(appId);
      allow delete: if isAdmin(appId);
    }

    // Backwards-compat: pluralized highlight storage prefix
    match /artifacts/{appId}/case_highlights/{caseId}/{file=**} {
      allow create, update: if isAdmin(appId) && isAllowedArtifactUpload();
      allow get, list: if isAdmin(appId);
      allow delete: if isAdmin(appId);
    }
  }
}
